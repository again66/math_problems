<!-- pages/arithmetic/arithmetic.wxml -->
<view class="container">
  <!-- é…ç½®é¢æ¿ -->
  <view class="config-panel">
    <view class="panel-title">é¢˜ç›®è®¾ç½®</view>
    
    <view class="config-group">
      <view class="config-item">
        <text class="label">é¢˜ç›®æ•°é‡</text>
        <view class="quick-buttons">
          <button 
            wx:for="{{[20, 40, 60]}}" 
            wx:key="*this"
            class="quick-btn {{config.problemCount == item ? 'active' : ''}}"
            bindtap="setQuickCount"
            data-count="{{item}}"
          >
            {{item}}é¢˜
          </button>
        </view>
        <input 
          type="number" 
          value="{{config.problemCount}}" 
          bindinput="updateConfig"
          data-field="problemCount"
          class="number-input"
        />
      </view>

      <view class="config-item">
        <text class="label">æ•°å­—èŒƒå›´</text>
        <view class="range-inputs">
          <text>1 - </text>
          <input 
            type="number" 
            value="{{config.maxNumber}}" 
            bindinput="updateConfig"
            data-field="maxNumber"
            class="number-input small"
          />
        </view>
      </view>
    </view>

    <view class="config-group">
      <view class="config-item">
        <text class="label">æ¯è¡Œé¢˜æ•°</text>
        <picker 
          range="{{['2é¢˜', '3é¢˜', '4é¢˜', '5é¢˜']}}" 
          value="{{config.columns - 2}}"
          bindchange="onColumnsChange"
        >
          <view class="picker">{{config.columns}}é¢˜</view>
        </picker>
      </view>
    </view>
  </view>

  <!-- é¢„è§ˆåŒºåŸŸ -->
  <view class="preview-panel">
    <view class="panel-header">
      <text class="panel-title">
        é¢„è§ˆ - å…±{{previewData.total}}é¢˜
        <text wx:if="{{showPageInfo}}" class="page-info">
          (é¢˜ç›®: 1-{{previewData.problemPages}}é¡µ, ç­”æ¡ˆ: {{previewData.answerStartPage}}é¡µèµ·)
        </text>
      </text>
      <view class="header-actions">
        <button class="action-btn" bindtap="togglePageInfo">
          {{showPageInfo ? 'éšè—' : 'æ˜¾ç¤º'}}é¡µæ•°
        </button>
        <view class="mode-switch">
          <button 
            class="mode-btn {{previewMode === 'problems' ? 'active' : ''}}"
            bindtap="switchPreviewMode"
            data-mode="problems"
          >
            é¢˜ç›®
          </button>
          <button 
            class="mode-btn {{previewMode === 'answers' ? 'active' : ''}}"
            bindtap="switchPreviewMode"
            data-mode="answers"
          >
            ç­”æ¡ˆ
          </button>
        </view>
      </view>
    </view>

    <view class="preview-content">
      <view wx:if="{{generating}}" class="loading">
        <text>é¢˜ç›®ç”Ÿæˆä¸­...</text>
      </view>
      
      <view wx:else class="preview-section">
        <!-- é¢˜ç›®é¢„è§ˆ -->
        <view wx:if="{{previewMode === 'problems'}}" class="problems-preview">
          <view class="preview-header">
            <text class="preview-title">é¢˜ç›®éƒ¨åˆ† (ç¬¬1-{{previewData.problemPages}}é¡µ)</text>
            <text class="preview-subtitle">å…±{{previewData.total}}é¢˜ - è¯·åœ¨ä¸‹æ–¹ç©ºç™½å¤„ç­”é¢˜</text>
          </view>
          <view class="problems-grid">
            <view class="problem-row" wx:for="{{previewData.problems}}" wx:key="index">
              <view class="problem-item" wx:for="{{item}}" wx:key="id">
                <text class="problem-number">{{item.id}}.</text>
                <text class="problem-expression">{{item.expression}}</text>
                <text class="problem-answer hide">____</text>
              </view>
            </view>
          </view>
        </view>

        <!-- ç­”æ¡ˆé¢„è§ˆ -->
        <view wx:else class="answers-preview">
          <view class="preview-header">
            <text class="preview-title">ç­”æ¡ˆéƒ¨åˆ† (ç¬¬{{previewData.answerStartPage}}é¡µèµ·)</text>
            <text class="preview-subtitle">å…±{{previewData.total}}é¢˜ - æ‰¹æ”¹å‚è€ƒ</text>
          </view>
          <view class="problems-grid answers">
            <view class="problem-row" wx:for="{{previewData.answers}}" wx:key="index">
              <view class="problem-item" wx:for="{{item}}" wx:key="id">
                <text class="problem-number">{{item.id}}.</text>
                <text class="problem-expression">{{item.expression}}</text>
                <text class="problem-answer show">{{item.answer}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- éšè—çš„canvas -->
  <view wx:if="{{showCanvas}}" style="position: fixed; left: -10000px; top: -10000px; width: 794px; height: 1123px;">
    <canvas 
      id="mathCanvas" 
      type="2d" 
      style="width: 794px; height: 1123px;"
    ></canvas>
  </view>

  <!-- è¿›åº¦æ˜¾ç¤º -->
  <view wx:if="{{generatingImages}}" class="progress-section">
    <view class="progress-bar">
      <view class="progress-inner" style="width: {{imageProgress}}%"></view>
    </view>
    <text class="progress-text">ç”Ÿæˆè¿›åº¦: {{imageProgress}}%</text>
  </view>

  <!-- ç”Ÿæˆçš„å›¾ç‰‡æ˜¾ç¤ºåŒºåŸŸ -->
  <view wx:if="{{showGeneratedImages && generatedImages.length > 0}}" class="images-section">
    <view class="section-header">
      <text class="section-title">ç”Ÿæˆçš„å›¾ç‰‡ ({{generatedImages.length}}å¼ )</text>
      <view class="header-actions">
        <button class="action-btn small" bindtap="saveAllImagesToAlbum">
          ğŸ’¾ ä¿å­˜å…¨éƒ¨
        </button>
      </view>
    </view>

    <!-- å›¾ç‰‡å¯¼èˆªå’Œæ˜¾ç¤º -->
    <view class="image-viewer">
      <!-- å›¾ç‰‡å¯¼èˆª -->
      <view class="image-nav">
        <button class="nav-btn" bindtap="switchImage" data-direction="prev">â—€ ä¸Šä¸€å¼ </button>
        <text class="nav-info">ç¬¬ {{currentImageIndex + 1}} / {{generatedImages.length}} å¼ </text>
        <button class="nav-btn" bindtap="switchImage" data-direction="next">ä¸‹ä¸€å¼  â–¶</button>
      </view>

      <!-- å½“å‰å›¾ç‰‡æ˜¾ç¤º -->
      <view class="current-image-container">
        <image 
          src="{{generatedImages[currentImageIndex]}}" 
          class="current-image"
          mode="widthFix"
          bindtap="previewCurrentImage"
        />
        <view class="image-info">
          <text class="image-type">{{currentImageIndex < generatedImages.length / 2 ? 'é¢˜ç›®' : 'ç­”æ¡ˆ'}}é¡µ</text>
          <text class="image-page">ç¬¬ {{currentImageIndex % (generatedImages.length / 2) + 1}} é¡µ</text>
        </view>
      </view>

      <!-- å›¾ç‰‡æ“ä½œæŒ‰é’® -->
      <view class="image-actions">
        <button class="action-btn secondary" bindtap="saveCurrentImage">
          ğŸ’¾ ä¿å­˜æœ¬å¼ 
        </button>
        <button class="action-btn primary" bindtap="previewCurrentImage">
          ğŸ” æŸ¥çœ‹å¤§å›¾
        </button>
      </view>

      <!-- ç¼©ç•¥å›¾å¯¼èˆª -->
      <view class="thumbnails">
        <view 
          wx:for="{{generatedImages}}" 
          wx:key="index"
          class="thumbnail-item {{index === currentImageIndex ? 'active' : ''}}"
          bindtap="goToImage"
          data-index="{{index}}"
        >
          <image src="{{item}}" class="thumbnail-image" mode="aspectFill" />
          <text class="thumbnail-label">{{index < generatedImages.length / 2 ? 'é¢˜' : 'ç­”'}}{{index % (generatedImages.length / 2) + 1}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æ“ä½œæŒ‰é’® -->
  <view class="action-bar">
    <button class="btn regenerate-btn" bindtap="generateProblems" loading="{{generating}}">
      ğŸ”„ é‡æ–°ç”Ÿæˆ
    </button>
    <button class="btn export-btn" bindtap="generateImages" loading="{{generatingImages}}">
      {{generatingImages ? 'ç”Ÿæˆä¸­...' : 'ğŸ–¼ï¸ ç”ŸæˆA4å›¾ç‰‡'}}
    </button>
  </view>
</view>